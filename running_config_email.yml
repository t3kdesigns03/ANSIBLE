running_config_email.yml
---
- name: Export Meraki SD-WAN running configuration
  hosts: localhost
  gather_facts: no
  vars_files:
    - ./group_vars/merakivault.yml
  vars:
    network_id: "N_812899732740392528"
    device_serial: "Q2TW-DBVG-LJ9Q"
    base_url: "https://api.meraki.com/api/v1/networks/{{ network_id }}"
    csv_path: "/tmp"
    csv_filename: "meraki_running_config_{{ network_id }}_{{ ansible_date_time.iso8601_basic_short }}.csv"
    email_subject: "Meraki MX450 Running Config (Network {{ network_id }})"
    email_host: "192.168.200.150"
    email_from: "xxxx@xyz.net"
    email_body: "Attached is the running configuration for Meraki MX450 (Network: {{ network_id }}, Serial: {{ device_serial }})."
    email_to: "xxxx@yzy.net, xxxxxx@xyz.net"
    git_repo_url: "{{ vault_git_repo_url | default('https://github.com/yourusername/yourrepo.git') }}"
    git_branch: "{{ vault_git_branch | default('main') }}"
    git_username: "{{ vault_git_username | default('yourusername') }}"
    git_password: "{{ vault_git_password | default('yourtoken') }}"
    headers:
      X-Cisco-Meraki-API-Key: "{{ vault_meraki_apikey }}"
      Content-Type: "application/json"

  tasks:
    - name: Get Device Details
      uri:
        url: "{{ base_url }}/devices/{{ device_serial }}"
        method: GET
        headers: "{{ headers }}"
        return_content: yes
        status_code: 200
      register: device_details

    - name: Save Device Details
      copy:
        content: "{{ device_details.content }}"
        dest: "./device_details.json"

    - name: Get Route Table (Static Routes)
      uri:
        url: "{{ base_url }}/appliance/staticRoutes"
        method: GET
        headers: "{{ headers }}"
        return_content: yes
        status_code: 200
      register: route_table

    - name: Save Route Table
      copy:
        content: "{{ route_table.content }}"
        dest: "./route_table.json"

    - name: Get VLAN Settings
      uri:
        url: "{{ base_url }}/appliance/vlans/settings"
        method: GET
        headers: "{{ headers }}"
        return_content: yes
        status_code: 200
      register: vlan_settings

    - name: Get VLANs
      uri:
        url: "{{ base_url }}/appliance/vlans"
        method: GET
        headers: "{{ headers }}"
        return_content: yes
        status_code: 200
      register: vlans
      when: vlan_settings.json.vlansEnabled | bool

    - name: Save VLANs
      copy:
        content: "{{ vlans.content | default('[]') }}"
        dest: "./vlans.json"
      when: vlan_settings.json.vlansEnabled | bool

    - name: Get L3 Firewall Rules
      uri:
        url: "{{ base_url }}/appliance/firewall/l3FirewallRules"
        method: GET
        headers: "{{ headers }}"
        return_content: yes
        status_code: 200
      register: l3_firewall_rules

    - name: Save L3 Firewall Rules
      copy:
        content: "{{ l3_firewall_rules.content }}"
        dest: "./l3_firewall_rules.json"

    - name: Get Site-to-Site VPN
      uri:
        url: "{{ base_url }}/appliance/vpn/siteToSiteVpn"
        method: GET
        headers: "{{ headers }}"
        return_content: yes
        status_code: 200
      register: s2s_vpn

    - name: Save Site-to-Site VPN
      copy:
        content: "{{ s2s_vpn.content }}"
        dest: "./site_to_site_vpn.json"

    - name: Get Traffic Shaping Rules
      uri:
        url: "{{ base_url }}/appliance/trafficShaping/rules"
        method: GET
        headers: "{{ headers }}"
        return_content: yes
        status_code: 200
      register: traffic_shaping_rules

    - name: Save Traffic Shaping Rules
      copy:
        content: "{{ traffic_shaping_rules.content }}"
        dest: "./traffic_shaping_rules.json"

    - name: Render Running Config CSV
      template:
        src: templates/meraki_running_config_csv.j2
        dest: "{{ csv_path }}/{{ csv_filename }}"
      vars:
        device_details: "{{ device_details.json }}"
        route_table: "{{ route_table.json }}"
        vlan_settings: "{{ vlan_settings.json }}"
        vlans: "{{ vlans.json | default([]) }}"
        l3_firewall_rules: "{{ l3_firewall_rules.json }}"
        s2s_vpn: "{{ s2s_vpn.json }}"
        traffic_shaping_rules: "{{ traffic_shaping_rules.json }}"
      register: render_result

    - name: Debug Rendered Config
      debug:
        msg: "{{ render_result.dest_content | default('No content rendered') }}"
      when: render_result.dest_content is defined

    - name: Verify CSV File
      stat:
        path: "{{ csv_path }}/{{ csv_filename }}"
      register: file_stat

    - name: Debug File Status
      debug:
        msg: "File {{ csv_filename }} exists: {{ file_stat.stat.exists }}, Size: {{ file_stat.stat.size | default(0) }} bytes"

    - name: Send Email
      mail:
        host: "{{ email_host }}"
        from: "{{ email_from }}"
        port: 25
        to: "{{ email_to }}"
        subject: "[Ansible] {{ email_subject }}"
        body: "{{ email_body }}"
        attach: "{{ csv_path }}/{{ csv_filename }}"
        subtype: html
      delegate_to: localhost
      run_once: true
      when: file_stat.stat.exists | bool

    - name: Initialize Git Repository
      git:
        repo: "{{ git_repo_url }}"
        dest: "/tmp/meraki_config_repo"
        version: "{{ git_branch }}"
        accept_hostkey: yes
      delegate_to: localhost

    - name: Copy CSV to Git Repository
      copy:
        src: "{{ csv_path }}/{{ csv_filename }}"
        dest: "/tmp/meraki_config_repo/{{ csv_filename }}"
      delegate_to: localhost

    - name: Commit CSV to Git
      command: |
        git -C /tmp/meraki_config_repo add {{ csv_filename }}
        git -C /tmp/meraki_config_repo commit -m "Add Meraki running config for {{ network_id }} - {{ ansible_date_time.iso8601 }}"
      register: git_commit
      failed_when: git_commit.rc != 0 and 'nothing to commit' not in git_commit.stderr
      changed_when: git_commit.rc == 0
      delegate_to: localhost

    - name: Push to Git Repository
      command: |
        git -C /tmp/meraki_config_repo push origin {{ git_branch }}
      environment:
        GIT_ASKPASS: "/bin/echo {{ git_password }}"
        GIT_USERNAME: "{{ git_username }}"
      register: git_push
      failed_when: git_push.rc != 0
      delegate_to: localhost

    - name: Clean Up CSV File
      file:
        path: "{{ csv_path }}/{{ csv_filename }}"
        state: absent
      delegate_to: localhost